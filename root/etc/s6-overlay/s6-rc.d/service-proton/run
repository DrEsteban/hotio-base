#!/command/with-contenv bash
# shellcheck shell=bash

umask "${UMASK}"

vpn_gw=$(grep Address "${CONFIG_DIR}/wireguard/${VPN_CONF}.conf" | awk -F '=' '{print $2}' | xargs)
vpn_gw="${vpn_gw%.*}.1"

while true; do
    if ! natpmpc -g "${vpn_gw}" &> /dev/null; then
        echo "[WRN] [$(date '+%Y-%m-%d %H:%M:%S')] [PROTON] Endpoint \"${vpn_gw%.*}.1\" does not support port forwarding!"
    else
        port=$(natpmpc -g "${vpn_gw}" -a 1 0 udp 60 | grep -P -o -m 1 '(?<=Mapped public port\s)\d+')
        if [[ -n "${port}" ]]; then
            natpmpc -g "${vpn_gw}" -a 1 0 tcp 60 &> /dev/null
            touch "${CONFIG_DIR}/wireguard/forwarded_port"
            old_port=$(cat "${CONFIG_DIR}/wireguard/forwarded_port")
            if [[ "${port}" != "${old_port}" ]]; then
                echo "[INF] [$(date '+%Y-%m-%d %H:%M:%S')] [PROTON] Forwarded port is \"${port}\"."
                echo "${port}" > "${CONFIG_DIR}/wireguard/forwarded_port"
                # shellcheck source=/dev/null
                source "${APP_DIR}/forwarded_port_update_app"
            fi
        else
            echo "[WRN] [$(date '+%Y-%m-%d %H:%M:%S')] [PROTON] Port forwarding failed!"
        fi
    fi
    sleep 45
done
